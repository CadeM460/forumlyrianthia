<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Lyrianthia Forum</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Supabase (ONLY ONCE) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { background:#0b0f14; color:white; font-family:Arial; margin:0; }
nav { background:#111; padding:15px; display:flex; gap:20px; }
nav span { cursor:pointer; }
button { padding:6px 10px; margin-top:5px; cursor:pointer; }
input, textarea { padding:6px; width:100%; margin:5px 0; }
.card { background:#111; padding:15px; margin:15px; border-radius:8px; }
.hidden { display:none; }
.chat { height:250px; overflow-y:auto; background:#1a1f26; padding:10px; }
.thread { padding:8px; border-bottom:1px solid #333; cursor:pointer; }
.thread:hover { background:#1a1f26; }
</style>
</head>
<body>

<nav id="nav" class="hidden">
  <span id="tabProfile">Profile</span>
  <span id="tabForum">Forum</span>
  <span id="logoutBtn">Logout</span>
</nav>

<div id="auth">
  <div class="card">
    <h3>Login</h3>
    <input id="loginEmail" placeholder="Email">
    <input id="loginPassword" type="password" placeholder="Password">
    <button id="loginBtn">Login</button>
  </div>

  <div class="card">
    <h3>Register</h3>
    <input id="regEmail" placeholder="Email">
    <input id="regPassword" type="password" placeholder="Password">
    <button id="registerBtn">Register</button>
  </div>
</div>

<div id="app" class="hidden">

<div id="profileTab" class="card">
  <h3>Profile</h3>
  Email: <span id="profileEmail"></span><br>
  Username: <span id="profileUsername"></span><br>
  Role: <span id="profileRole"></span>
</div>

<div id="forumTab" class="card hidden">
  <h3>Create Thread</h3>
  <input id="threadTitle" placeholder="Thread Title">
  <textarea id="threadDesc" placeholder="Description"></textarea>
  <button id="createThreadBtn">Create</button>

  <h3>Threads</h3>
  <div id="threads"></div>

  <div id="threadView" class="hidden">
    <h3 id="viewTitle"></h3>
    <p id="viewDesc"></p>
    <div id="posts"></div>
    <textarea id="replyBox" placeholder="Reply"></textarea>
    <button id="replyBtn">Reply</button>
  </div>
</div>

<div class="card">
  <h3>Global Chat</h3>
  <div id="chat" class="chat"></div>
  <input id="chatInput">
  <button id="chatBtn">Send</button>
</div>

</div>

<script>
/* ================================
   SUPABASE INIT (ONLY HERE ONCE)
================================ */

const supabase = window.supabase.createClient(
  "https://vzcofzfwjiswobrmdpvz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6Y29memZ3amlzd29icm1kcHZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1ODM0NDAsImV4cCI6MjA4NjE1OTQ0MH0.82RKlpOrVMTg3CPZOIx4_R6-6KoK8FUs9mp1i32VBN4"
);

let currentUser = null;
let profile = null;
let activeThread = null;

/* ================================
   AUTH
================================ */

async function register() {
  const { error } = await supabase.auth.signUp({
    email: document.getElementById("regEmail").value,
    password: document.getElementById("regPassword").value,
    options: { emailRedirectTo: window.location.origin }
  });

  if (error) alert(error.message);
  else alert("Check your email to confirm.");
}

async function login() {
  const { error } = await supabase.auth.signInWithPassword({
    email: document.getElementById("loginEmail").value,
    password: document.getElementById("loginPassword").value
  });

  if (error) alert(error.message);
  else location.reload();
}

async function logout() {
  await supabase.auth.signOut();
  location.reload();
}

/* ================================
   INIT USER
================================ */

async function init() {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) return;

  currentUser = session.user;

  const { data: existing } = await supabase
    .from("profiles")
    .select("*")
    .eq("id", currentUser.id)
    .single();

  if (!existing) {
    await supabase.from("profiles").insert({
      id: currentUser.id,
      username: currentUser.email.split("@")[0],
      role: "user"
    });
  }

  const { data } = await supabase
    .from("profiles")
    .select("*")
    .eq("id", currentUser.id)
    .single();

  profile = data;

  document.getElementById("auth").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");
  document.getElementById("nav").classList.remove("hidden");

  document.getElementById("profileEmail").innerText = currentUser.email;
  document.getElementById("profileUsername").innerText = profile.username;
  document.getElementById("profileRole").innerText = profile.role;

  loadThreads();
  loadChat();
  setupRealtime();
}

/* ================================
   REALTIME CHAT
================================ */

function setupRealtime() {
  supabase.channel("chat-live")
    .on("postgres_changes",
      { event: "INSERT", schema: "public", table: "chat_messages" },
      payload => addChatMessage(payload.new)
    )
    .subscribe();
}

function addChatMessage(msg) {
  const chat = document.getElementById("chat");
  chat.innerHTML += `<div><b>${msg.username}</b>: ${msg.content}</div>`;
  chat.scrollTop = chat.scrollHeight;
}

async function loadChat() {
  const { data } = await supabase
    .from("chat_messages")
    .select("*")
    .order("created_at");

  document.getElementById("chat").innerHTML = "";
  data.forEach(addChatMessage);
}

async function sendChat() {
  await supabase.from("chat_messages").insert({
    user_id: currentUser.id,
    username: profile.username,
    content: document.getElementById("chatInput").value
  });

  document.getElementById("chatInput").value = "";
}

/* ================================
   THREADS
================================ */

async function createThread() {
  await supabase.from("threads").insert({
    title: document.getElementById("threadTitle").value,
    description: document.getElementById("threadDesc").value,
    creator_id: currentUser.id
  });

  document.getElementById("threadTitle").value = "";
  document.getElementById("threadDesc").value = "";

  loadThreads();
}

async function loadThreads() {
  const { data } = await supabase
    .from("threads")
    .select("*")
    .order("created_at", { ascending: false });

  const container = document.getElementById("threads");
  container.innerHTML = "";

  data.forEach(thread => {
    const div = document.createElement("div");
    div.className = "thread";
    div.innerHTML = `<b>${thread.title}</b><br>${thread.description}`;
    div.addEventListener("click", () => openThread(thread.id));
    container.appendChild(div);
  });
}

async function openThread(id) {
  activeThread = id;

  const { data } = await supabase
    .from("threads")
    .select("*")
    .eq("id", id)
    .single();

  document.getElementById("threadView").classList.remove("hidden");
  document.getElementById("viewTitle").innerText = data.title;
  document.getElementById("viewDesc").innerText = data.description;

  loadPosts();
}

async function loadPosts() {
  const { data } = await supabase
    .from("posts")
    .select("*")
    .eq("thread_id", activeThread)
    .order("created_at");

  const postsDiv = document.getElementById("posts");
  postsDiv.innerHTML = "";

  data.forEach(post => {
    postsDiv.innerHTML += `<div><b>${post.username}</b>: ${post.content}</div>`;
  });
}

async function reply() {
  await supabase.from("posts").insert({
    thread_id: activeThread,
    author_id: currentUser.id,
    username: profile.username,
    content: document.getElementById("replyBox").value
  });

  document.getElementById("replyBox").value = "";
  loadPosts();
}

/* ================================
   EVENTS (NO INLINE JS)
================================ */

document.getElementById("loginBtn").addEventListener("click", login);
document.getElementById("registerBtn").addEventListener("click", register);
document.getElementById("logoutBtn").addEventListener("click", logout);
document.getElementById("chatBtn").addEventListener("click", sendChat);
document.getElementById("createThreadBtn").addEventListener("click", createThread);
document.getElementById("replyBtn").addEventListener("click", reply);

document.getElementById("tabProfile").addEventListener("click", () => {
  document.getElementById("profileTab").classList.remove("hidden");
  document.getElementById("forumTab").classList.add("hidden");
});

document.getElementById("tabForum").addEventListener("click", () => {
  document.getElementById("forumTab").classList.remove("hidden");
  document.getElementById("profileTab").classList.add("hidden");
});

init();
</script>

</body>
</html>
